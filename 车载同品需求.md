# 车载媒体播放器 - 同品需求分析文档

## 一、项目概述

### 1.1 参考项目
- **项目名称**: 百度网盘TV播放器
- **项目类型**: Android TV应用
- **开发语言**: Java
- **目标设备**: Android TV（Sony 65寸电视）

### 1.2 车载应用定位
基于TV播放器的成功经验，开发适用于车载系统的媒体播放器应用，支持云端媒体文件的浏览和播放。

---

## 二、技术栈分析

### 2.1 核心技术栈

| 技术类别 | 技术选型 | 版本 | 用途说明 |
|---------|---------|------|---------|
| **开发语言** | Java | 1.8 | 主要开发语言 |
| **最低SDK** | Android 9.0 (API 28) | - | 兼容性要求 |
| **目标SDK** | Android 14 (API 35) | - | 最新特性支持 |
| **架构模式** | MVVM | - | 分层架构设计 |
| **UI框架** | Android TV Leanback | 1.0.0 | TV专用UI组件 |
| **生命周期** | Lifecycle | 2.6.1 | 组件生命周期管理 |
| **数据观察** | LiveData | 2.6.1 | 响应式数据更新 |
| **数据库** | Room | 2.5.0 | 本地数据持久化 |
| **网络请求** | Retrofit | 2.9.0 | RESTful API调用 |
| **HTTP客户端** | OkHttp | 4.10.0 | 网络请求底层实现 |
| **图片加载** | Glide | 4.15.1 | 图片加载和缓存 |
| **视频播放** | Media3 (ExoPlayer) | 1.5.0 | 主力视频播放器 |
| **视频播放** | VLC | 3.5.1 | 备用播放器（格式支持更广） |
| **颜色提取** | Palette | 1.0.0 | 图片主色调提取 |
| **二维码** | ZXing | 3.5.1 | 二维码生成和识别 |
| **JSON解析** | Gson | 2.10.1 | JSON序列化/反序列化 |
| **元数据解析** | MP4Parser | 1.1.22 | 视频元数据提取 |

### 2.2 车载适配建议

#### 2.2.1 硬件适配
- **屏幕尺寸**: 车载屏幕通常为7-15寸，需要适配不同分辨率
- **触摸屏**: 车载系统通常支持触摸，需要同时支持触摸和物理按键
- **音频输出**: 需要支持车载音响系统的音频路由
- **网络连接**: 需要支持4G/5G和WiFi网络切换

#### 2.2.2 系统适配
- **Android Automotive OS**: 优先适配Android Automotive系统
- **Car App Library**: 使用Car App Library提供车载专用UI组件
- **驾驶模式**: 需要支持驾驶模式下的简化界面
- **语音控制**: 集成车载语音助手（如Google Assistant、小度等）

#### 2.2.3 安全适配
- **驾驶安全**: 播放器界面需要简洁，避免分散驾驶员注意力
- **自动播放**: 车辆启动时可自动播放上次内容
- **后台播放**: 支持导航时后台播放媒体

---

## 三、功能清单

### 3.1 核心功能模块

#### 3.1.1 用户认证模块
**功能描述**: 支持云端存储服务的用户登录

**具体功能**:
- ✅ 二维码扫码登录（手机扫码授权）
- ✅ Token自动刷新机制
- ✅ 登录状态持久化
- ✅ 退出登录功能
- ✅ 多账号支持（可选）

**技术实现**:
- OAuth 2.0设备码流程
- SharedPreferences存储Token
- 定期轮询Token状态

**车载适配**:
- 支持车载屏幕显示二维码
- 支持手机App扫码授权
- 支持语音指令"登录账号"

---

#### 3.1.2 文件浏览模块
**功能描述**: 浏览云端存储的媒体文件

**具体功能**:
- ✅ 目录树形浏览
- ✅ 文件列表展示（网格/列表视图切换）
- ✅ 文件缩略图预览
- ✅ 递归加载子目录
- ✅ 文件排序（名称/时间/大小）
- ✅ 文件搜索功能
- ✅ 多选文件/目录

**技术实现**:
- RecyclerView + Adapter
- Glide加载缩略图
- 异步文件列表获取
- 分页加载优化

**车载适配**:
- 大图标显示，便于触摸操作
- 语音搜索文件
- 快速访问常用目录

---

#### 3.1.3 播放列表管理模块
**功能描述**: 创建和管理播放列表

**具体功能**:
- ✅ 创建播放列表（多选目录/文件）
- ✅ 播放列表展示（卡片式布局）
- ✅ 播放列表播放
- ✅ 断点续播（记录播放位置）
- ✅ 播放列表编辑（添加/删除文件）
- ✅ 播放列表删除
- ✅ 播放列表重命名
- ✅ 播放列表刷新（重新扫描源目录）
- ✅ 播放列表封面自定义

**技术实现**:
- Room数据库存储
- 外键级联删除
- 记录源路径支持刷新
- LiveData实时更新

**车载适配**:
- 快速创建常用播放列表
- 语音指令"播放我的旅行照片"
- 驾驶模式自动播放

---

#### 3.1.4 视频播放模块
**功能描述**: 播放视频文件

**具体功能**:
- ✅ 多格式支持（MP4, MOV, MKV, AVI, H.265, HEVC, Dolby Vision）
- ✅ 横竖屏自适应
- ✅ 播放控制（播放/暂停/快进/快退）
- ✅ 进度条显示和拖动
- ✅ 音量控制
- ✅ 全屏播放
- ✅ 预加载下一个视频
- ✅ 播放速度调节（0.5x - 2.0x）
- ✅ 字幕支持（可选）

**技术实现**:
- Media3 (ExoPlayer) 为主力播放器
- VLC作为备用播放器
- 自适应码率流（HLS/DASH）
- 硬件加速解码

**车载适配**:
- 大按钮控制，便于触摸
- 语音控制（"暂停"、"快进10秒"）
- 导航时自动暂停
- 支持车载方向盘按键控制

---

#### 3.1.5 图片播放模块
**功能描述**: 播放图片文件

**具体功能**:
- ✅ 多格式支持（JPEG, JPG, PNG, AVIF, WebP, HEIC）
- ✅ 图片特效（淡入淡出、缓动、浮现、跳动、百叶窗、旋转、缩放、滑动、反弹）
- ✅ 播放模式（顺序/随机/单曲循环/倒序）
- ✅ 展示时长可调（3-30秒）
- ✅ 特效时长可调（500-2000ms）
- ✅ 图片背景模式（纯黑色/主色调/毛玻璃）
- ✅ 地点识别显示（从EXIF提取GPS）
- ✅ 缩放查看（双指缩放）
- ✅ 预加载下一张图片

**技术实现**:
- Glide加载图片
- ViewPropertyAnimator实现特效
- Palette提取主色调
- RenderScript实现毛玻璃
- ExifInterface提取GPS
- Geocoder转换为地址

**车载适配**:
- 自动轮播，适合停车时观看
- 语音控制（"下一张"、"放大"）
- 驾驶时简化显示

---

#### 3.1.6 播放记录模块
**功能描述**: 记录播放历史

**具体功能**:
- ✅ 保存最近播放记录（最多10条）
- ✅ 显示最近播放（首页展示4条）
- ✅ 点击直接播放
- ✅ 记录播放位置（视频进度/图片索引）
- ✅ 记录播放时间

**技术实现**:
- Room数据库存储
- 自动清理旧记录
- LiveData实时更新

**车载适配**:
- 快速恢复上次播放
- 语音指令"继续播放"

---

#### 3.1.7 设置模块
**功能描述**: 应用设置管理

**具体功能**:
- ✅ 图片展示特效选择（9种特效）
- ✅ 图片展示时长调节（3-30秒）
- ✅ 播放顺序选择（顺序/随机/单曲循环/倒序）
- ✅ 显示拍摄地点开关
- ✅ 图片背景模式选择（纯黑色/主色调/毛玻璃）
- ✅ 退出登录
- ✅ 清除缓存

**技术实现**:
- SharedPreferences存储设置
- 设置界面使用PreferenceFragment
- 实时生效

**车载适配**:
- 简化设置选项
- 语音设置（"设置随机播放"）
- 驾驶模式锁定部分设置

---

#### 3.1.8 遥控器/按键支持模块
**功能描述**: 支持物理按键操作

**具体功能**:
- ✅ 方向键导航（上/下/左/右）
- ✅ 确认键选择
- ✅ 返回键返回
- ✅ 菜单键打开设置
- ✅ 播放/暂停键控制播放
- ✅ 快进/快退键控制进度
- ✅ 焦点视觉反馈（边框+缩放）
- ✅ 默认焦点智能设置

**技术实现**:
- 所有可交互元素设置focusable
- 自定义焦点样式
- onKeyDown事件处理
- 焦点动画效果

**车载适配**:
- 支持车载物理按键
- 支持方向盘按键
- 支持语音指令
- 触摸屏手势支持

---

### 3.2 高级功能模块

#### 3.2.1 地点识别模块
**功能描述**: 识别媒体文件的拍摄地点

**具体功能**:
- ✅ 从EXIF数据提取GPS坐标
- ✅ 使用Geocoder转换为地址
- ✅ 在播放时显示地点信息
- ✅ 支持多种地理编码策略（Android原生/高德地图/OpenStreetMap）

**技术实现**:
- ExifInterface读取EXIF
- Geocoder API
- 异步处理避免阻塞UI
- 独立进程处理（防止崩溃）

**车载适配**:
- 显示拍摄地点，增强回忆体验
- 语音询问"这是在哪里拍的？"
- 结合车载GPS显示距离

---

#### 3.2.2 图片背景优化模块
**功能描述**: 优化图片播放时的背景效果

**具体功能**:
- ✅ 纯黑色背景（传统模式）
- ✅ 主色调背景（提取图片主色调）
- ✅ 毛玻璃背景（图片模糊效果）
- ✅ LRU缓存机制
- ✅ 异步处理
- ✅ 性能优化

**技术实现**:
- Palette库提取主色调
- RenderScript实现模糊
- LRU缓存管理
- 硬件加速

**车载适配**:
- 根据车载屏幕亮度自动调整
- 夜间模式自动切换背景

---

#### 3.2.3 网络优化模块
**功能描述**: 优化网络请求和媒体加载

**具体功能**:
- ✅ OkHttp连接池
- ✅ 请求重试机制
- ✅ 网络状态监听
- ✅ 自适应码率
- ✅ 预加载机制
- ✅ 缓存策略

**技术实现**:
- OkHttp拦截器
- 网络状态广播
- ExoPlayer自适应码率
- Glide缓存策略

**车载适配**:
- 支持4G/5G和WiFi自动切换
- 离线缓存常用内容
- 低流量模式

---

### 3.3 车载专属功能模块

#### 3.3.1 驾驶模式
**功能描述**: 驾驶时的简化界面

**具体功能**:
- ✅ 简化UI，减少干扰
- ✅ 大按钮显示
- ✅ 自动播放
- ✅ 语音优先
- ✅ 锁定复杂操作

**技术实现**:
- 检测车辆状态（通过Car API）
- 切换不同布局
- 限制功能访问

---

#### 3.3.2 语音控制
**功能描述**: 语音指令控制播放器

**具体功能**:
- ✅ 播放控制（"播放"、"暂停"、"下一首"）
- ✅ 播放列表控制（"播放我的旅行照片"）
- ✅ 搜索功能（"搜索海边照片"）
- ✅ 设置控制（"设置随机播放"）
- ✅ 信息查询（"这是在哪里拍的？"）

**技术实现**:
- 集成车载语音助手
- 自定义语音指令
- 自然语言处理

---

#### 3.3.3 导航集成
**功能描述**: 与车载导航系统集成

**具体功能**:
- ✅ 导航时自动暂停
- ✅ 导航结束后恢复播放
- ✅ 显示拍摄地点到当前位置的距离
- ✅ 语音播报导航信息时降低媒体音量

**技术实现**:
- Car API集成
- 音频焦点管理
- 事件监听

---

#### 3.3.4 多用户支持
**功能描述**: 支持多用户切换

**具体功能**:
- ✅ 用户切换
- ✅ 独立的播放列表
- ✅ 独立的播放记录
- ✅ 独立的设置

**技术实现**:
- 用户ID关联数据
- 数据库多用户隔离
- 快速切换

---

## 四、数据库设计

### 4.1 数据库表结构

#### 4.1.1 播放列表表 (playlists)
```java
@Entity(tableName = "playlists")
public class Playlist {
    @PrimaryKey(autoGenerate = true)
    private long id;                    // 播放列表ID
    
    private String name;                // 播放列表名称
    private long createdAt;             // 创建时间（毫秒）
    private long lastPlayedAt;          // 最后播放时间（毫秒）
    private int lastPlayedIndex;        // 最后播放的文件索引
    private int mediaType;              // 媒体类型：0=混合, 1=视频, 2=图片
    private String coverImagePath;      // 封面图片路径
    private int totalItems;             // 总文件数
    private long totalDuration;         // 总时长（毫秒，仅视频）
    private int sortOrder;              // 排序顺序
    private String sourcePaths;         // 源目录路径列表 (JSON格式)
    private long userId;                // 用户ID（多用户支持）
}
```

#### 4.1.2 播放列表项表 (playlist_items)
```java
@Entity(tableName = "playlist_items")
public class PlaylistItem {
    @PrimaryKey(autoGenerate = true)
    private long id;                    // 播放列表项ID
    
    private long playlistId;            // 所属播放列表ID
    private long fsId;                  // 云端文件ID
    private String filePath;            // 文件路径
    private String fileName;            // 文件名
    private int mediaType;              // 媒体类型：1=视频, 2=图片
    private int sortOrder;              // 排序顺序
    private long duration;              // 时长（毫秒）
    private long fileSize;              // 文件大小（字节）
}
```

#### 4.1.3 播放记录表 (playback_history)
```java
@Entity(tableName = "playback_history")
public class PlaybackHistory {
    @PrimaryKey(autoGenerate = true)
    private long id;                    // 记录ID
    
    private long fsId;                  // 文件ID
    private String filePath;            // 文件路径
    private String fileName;            // 文件名
    private int mediaType;              // 媒体类型
    private long playedAt;              // 播放时间
    private long position;              // 播放位置（视频进度/图片索引）
    private long userId;                // 用户ID
}
```

#### 4.1.4 用户表 (users) - 新增
```java
@Entity(tableName = "users")
public class User {
    @PrimaryKey(autoGenerate = true)
    private long id;                    // 用户ID
    
    private String name;                // 用户名称
    private String avatar;              // 用户头像
    private long createdAt;             // 创建时间
    private long lastActiveAt;          // 最后活跃时间
    private boolean isActive;           // 是否当前活跃
}
```

---

## 五、UI/UX设计

### 5.1 首页设计

```
┌────────────────────────────────────────────────────────────────┐
│  车载媒体播放器                         [语音按钮] [用户头像]  │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  我的播放列表                                       ← ─────→   │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐      │
│  │ [封面]   │  │ [封面]   │  │ [封面]   │  │ [封面]   │      │
│  │          │  │          │  │          │  │          │      │
│  │ 家庭照片 │  │ 旅行视频 │  │ 电影收藏 │  │ 音乐MV   │ ... │
│  │ 120张    │  │ 45个     │  │ 23个     │  │ 67个     │      │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘      │
│                                                                │
│  快速操作                                                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                    │
│  │  📂      │  │  ➕      │  │  🔍      │                    │
│  │ 浏览文件 │  │创建播放  │  │ 搜索文件 │                    │
│  │          │  │  列表    │  │          │                    │
│  └──────────┘  └──────────┘  └──────────┘                    │
│                                                                │
│  最近播放                                                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐      │
│  │ [缩略图] │  │ [缩略图] │  │ [缩略图] │  │ [缩略图] │      │
│  │ 文件名   │  │ 文件名   │  │ 文件名   │  │ 文件名   │      │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘      │
└────────────────────────────────────────────────────────────────┘
```

### 5.2 播放界面设计

```
┌────────────────────────────────────────────────────────────────┐
│                                                                │
│                                                                │
│                     [媒体内容显示区域]                         │
│                                                                │
│                                                                │
│                                                                │
├────────────────────────────────────────────────────────────────┤
│  [◀◀]  [▶]  [⏸]  [⏭]  [▶▶]  [🔄]  [⚙]  [📍]  [🔊]          │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│  00:05:23 / 00:45:30                                          │
└────────────────────────────────────────────────────────────────┘
```

### 5.3 驾驶模式设计

```
┌────────────────────────────────────────────────────────────────┐
│  🚗 驾驶模式                              [退出驾驶模式]       │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│                     [当前播放内容]                             │
│                                                                │
│                                                                │
│                                                                │
├────────────────────────────────────────────────────────────────┤
│  [⏸]  [⏭]  [🎤 语音指令]                                     │
└────────────────────────────────────────────────────────────────┘
```

---

## 六、性能优化

### 6.1 内存优化
- ✅ 使用Glide加载图片，自动缓存
- ✅ 使用ExoPlayer播放视频，自动缓存
- ✅ 及时释放不用的资源
- ✅ LRU缓存管理（背景缓存、播放列表缓存）
- ✅ Bitmap内存优化

### 6.2 网络优化
- ✅ OkHttp连接池
- ✅ 请求重试机制
- ✅ 网络状态监听
- ✅ 自适应码率
- ✅ 预加载机制
- ✅ 离线缓存

### 6.3 用户体验优化
- ✅ 加载进度提示
- ✅ 平滑的界面切换
- ✅ 焦点管理优化
- ✅ 异步处理避免卡顿
- ✅ 分页加载

### 6.4 车载专属优化
- ✅ 快速启动（<3秒）
- ✅ 低功耗模式
- ✅ 离线优先
- ✅ 流量节省
- ✅ 驾驶时简化渲染

---

## 七、安全性

### 7.1 数据安全
- ✅ Token加密存储
- ✅ HTTPS通信
- ✅ SSL证书验证
- ✅ 防止中间人攻击

### 7.2 驾驶安全
- ✅ 驾驶模式限制复杂操作
- ✅ 语音优先
- ✅ 大按钮设计
- ✅ 简化界面

### 7.3 隐私保护
- ✅ 用户数据隔离
- ✅ 权限最小化
- ✅ 数据本地化存储
- ✅ 可选的云端同步

---

## 八、开发建议

### 8.1 开发流程
1. 按照模块顺序开发：认证 → 主界面 → 文件浏览 → 播放器 → 车载适配
2. 每个模块完成后进行测试
3. 使用车载模拟器或真实车载设备进行测试

### 8.2 代码规范
- 遵循Android开发最佳实践
- 使用MVVM架构模式
- 合理使用LiveData和ViewModel
- 注意内存泄漏和资源释放
- 遵循车载应用开发规范

### 8.3 测试建议
- 在真实车载设备上测试
- 测试不同网络环境（4G/5G/WiFi）
- 测试各种媒体格式的兼容性
- 测试长时间运行
- 测试驾驶模式下的功能
- 测试语音控制功能

---

## 九、后续优化方向

### 9.1 功能扩展
- 支持更多云存储服务（阿里云盘、腾讯微云等）
- 添加字幕支持
- 实现播放列表分享
- 添加收藏功能
- 支持多设备同步
- 添加家长控制

### 9.2 车载专属
- 集成更多车载传感器（速度、方向等）
- 根据驾驶场景推荐内容
- 与车载音乐库集成
- 支持CarPlay/Android Auto
- AR导航集成

### 9.3 AI功能
- 智能内容推荐
- 人脸识别分类
- 场景识别
- 自动生成播放列表
- 语音助手增强

---

## 十、总结

### 10.1 核心优势
1. **成熟的技术栈**: 基于TV播放器的成功经验，技术栈成熟稳定
2. **完整的功能**: 涵盖媒体播放的核心功能
3. **良好的架构**: MVVM架构，代码清晰易维护
4. **车载适配**: 针对车载场景进行了专门优化
5. **用户体验**: 注重用户体验，支持多种交互方式

### 10.2 关键技术点
1. **播放列表管理**: 支持创建、编辑、刷新播放列表
2. **断点续播**: 记录播放位置，支持继续播放
3. **图片特效**: 9种图片切换特效
4. **地点识别**: 从EXIF提取GPS并显示地址
5. **背景优化**: 主色调和毛玻璃背景
6. **遥控器支持**: 完整的物理按键支持
7. **语音控制**: 车载语音助手集成

### 10.3 车载特色
1. **驾驶模式**: 简化界面，减少干扰
2. **语音控制**: 语音指令控制播放器
3. **导航集成**: 与车载导航系统集成
4. **多用户支持**: 支持多用户切换
5. **快速启动**: 优化启动速度

---

## 附录

### A. 参考文档
- [Android TV开发指南](https://developer.android.com/training/tv)
- [Android Automotive OS开发指南](https://developer.android.com/training/cars)
- [Car App Library文档](https://developer.android.com/training/cars/navigation)
- [ExoPlayer文档](https://exoplayer.dev/)
- [Room数据库文档](https://developer.android.com/training/data-storage/room)

### B. 相关文件
- TV播放器项目: `d:\devspace\tv-baidu-player`
- 架构文档: `ARCHITECTURE.md`
- 项目状态: `PROJECT_STATUS.md`
- 播放列表设计: `NEW_HOME_DESIGN.md`
- 遥控器指南: `REMOTE_CONTROL_GUIDE.md`

---

**文档版本**: v1.0  
**创建日期**: 2026-02-10  
**最后更新**: 2026-02-10  
**作者**: Copilot Code Pro